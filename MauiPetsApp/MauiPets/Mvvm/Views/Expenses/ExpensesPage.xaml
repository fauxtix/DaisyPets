<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="MauiPets.Mvvm.Views.Expenses.ExpensesPage"
             xmlns:models="clr-namespace:MauiPetsApp.Core.Application.ViewModels.Despesas;assembly=MauiPets.Core"
             xmlns:viewmodel="clr-namespace:MauiPets.Mvvm.ViewModels.Expenses"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:conv="clr-namespace:MauiPets.Converters"
             x:DataType="viewmodel:ExpensesViewModel"
             Title="Despesas">


    <ContentPage.Resources>
        <conv:StringToDateConverter x:Key="stringToDateConverter" />
        <conv:GreaterThanOneConverter x:Key="GreaterThanOneConverter" />
        <conv:LessThanTotalPagesConverter x:Key="LessThanTotalPagesConverter" />
    </ContentPage.Resources>

    <ContentPage.Behaviors>
        <toolkit:EventToCommandBehavior Command="{Binding GetExpensesCommand}" EventName="Appearing" />
    </ContentPage.Behaviors>

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Add Expense" Command="{Binding AddExpenseCommand}" 
                     CommandParameter="{Binding .}" 
                 IconImageSource="add.png" />
    </ContentPage.ToolbarItems>

    <Grid Margin="5, 0, 5, 5" Padding="0" RowDefinitions="Auto, Auto, Auto, Auto, Auto, *, Auto, Auto">
        <ScrollView>
            <VerticalStackLayout Padding="10">
                <Frame CornerRadius="15"
                   VerticalOptions="Start" 
                   HorizontalOptions="CenterAndExpand"
                   HasShadow="True"
                   Padding="10"
                   HeightRequest="80"
                   BackgroundColor="WhiteSmoke"
                   Grid.Row="0"
                   Margin="10,10,10,10"
                   BorderColor="Transparent">

                    <Frame.Background>
                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                            <GradientStop Color="#3498db" Offset="0.1" />
                            <GradientStop Color="#9b59b6" Offset="1.0" />
                        </LinearGradientBrush>
                    </Frame.Background>
                    <HorizontalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Spacing="5" Padding="5">
                        <Image Source="expenses.svg" WidthRequest="40" HeightRequest="40" VerticalOptions="Center" />
                        <Label Text="{Binding TotalGeralDespesas, Mode=OneWay, StringFormat='Total: {0:C2}'}"
                           FontSize="20"
                           FontAttributes="Bold"
                           TextColor="White"
                           VerticalOptions="Center" />
                    </HorizontalStackLayout>
                </Frame>
                <BoxView Grid.Row="1" HeightRequest="1" BackgroundColor="Black" Margin="0,8,0,8"/>
                <Frame CornerRadius="30"
                   VerticalOptions="Start"
                   HorizontalOptions="Center"
                   HasShadow="True"
                   Padding="15, 10"
                   BackgroundColor="White"
                   BorderColor="#dcdcdc"
                   Margin="1,15"
                   HeightRequest="60"
                   WidthRequest="370">
                    <FlexLayout Direction="Row"
                        JustifyContent="Center"
                        AlignItems="Center"
                        Wrap="NoWrap">
                        <Button Text="Este ano"
                            FontSize="14"
                            FontAttributes="Bold"
                            Command="{Binding FilterExpensesByYearCommand}"
                            BackgroundColor="#2ECC71"
                            TextColor="White"
                            CornerRadius="30"
                            WidthRequest="100"
                            HeightRequest="40"
                            BorderColor="Transparent"
                            FontFamily="OpenSansRegular"
                            Margin="0,0,10,0"/>
                        <Button Text="Este mês"
                            FontSize="14"
                            FontAttributes="Bold"
                            Command="{Binding FilterExpensesByMonthCommand}"
                            BackgroundColor="#3498db"
                            TextColor="White"
                            CornerRadius="30"
                            WidthRequest="100"
                            HeightRequest="40"
                            BorderColor="Transparent"
                            FontFamily="OpenSansRegular"
                            Margin="0,0,10,0"/>
                        <Button Text="Todas"
                            FontSize="14"
                            FontAttributes="Bold"
                            Command="{Binding GetExpensesCommand}"
                            BackgroundColor="#f1c40f"
                            TextColor="White"
                            CornerRadius="30"
                            WidthRequest="100"
                            HeightRequest="40"
                            BorderColor="Transparent"
                            FontFamily="OpenSansRegular"/>
                    </FlexLayout>
                </Frame>
                <BoxView Grid.Row="3" HeightRequest="1" BackgroundColor="Black" Margin="0,8,0,8"/>
                <CollectionView x:Name="expensesView" 
                            ItemsSource="{Binding Expenses}" 
                            VerticalScrollBarVisibility ="Always"
                                Grid.Row="4"
                            SelectionMode="Single">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout ItemSpacing="2" Orientation="Vertical" />
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:DespesaVM">
                            <SwipeView>
                                <SwipeView.RightItems>
                                    <SwipeItems SwipeBehaviorOnInvoked="Close">
                                        <SwipeItem Text="Delete"
                                               IconImageSource="icon_delete.svg"
                                               BackgroundColor="LightPink"
                                               Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:ExpensesViewModel}}, Path=DeleteExpenseCommand}"
                                               CommandParameter="{Binding .}" />
                                    </SwipeItems>
                                </SwipeView.RightItems>
                                <VerticalStackLayout>
                                    <Frame CornerRadius="10" HasShadow="True" Margin="4, 2, 4, 6" Padding="2">
                                        <Frame.GestureRecognizers>
                                            <TapGestureRecognizer
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:ExpensesViewModel}}, Path=EditExpenseCommand}"
                                            CommandParameter="{Binding .}" />
                                        </Frame.GestureRecognizers>
                                        <Grid Padding="2" ColumnSpacing="10" Margin="4" RowSpacing="3">
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                            </Grid.RowDefinitions>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>
                                            <Label Grid.Column="0"
                                               Text="{Binding DataMovimento, Converter={StaticResource stringToDateConverter}, StringFormat='{0:dd/MM/yyyy}'}"
                                               FontAttributes="Bold" />
                                            <Label Grid.Column="1"
                                               Text="{Binding DescricaoCategoriaDespesa, Mode=OneTime}"
                                               FontAttributes="Italic"
                                               VerticalOptions="End" />
                                            <Label Grid.Column="2"
                                               Text="{Binding ValorPago, Mode=OneWay, StringFormat='{0:C2}'}"
                                               HorizontalOptions="End"
                                               VerticalOptions="Start" />
                                        </Grid>
                                    </Frame>
                                </VerticalStackLayout>
                            </SwipeView>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                <!-- Pagination Controls -->
                <StackLayout Padding="1, 10, 1, 10" Spacing="5" HorizontalOptions="Center" Margin="0, 2, 1, 0"
                         VerticalOptions="Center" Orientation="Horizontal"
                         Grid.Row="5"
                         IsVisible="{Binding IsPaginationVisible}">
                    <Button Text="Início" Command="{Binding FirstPageCommand}" CornerRadius="10" WidthRequest="80" />
                    <Button Text="Anterior" Command="{Binding PreviousPageCommand}" CornerRadius="10"
                        IsEnabled="{Binding CurrentPage, 
                        Converter={StaticResource GreaterThanOneConverter}}" WidthRequest="90" />
                    <Button Text="Seguinte" 
                        Command="{Binding NextPageCommand}" 
                        CornerRadius="10" WidthRequest="90">
                        <Button.IsEnabled>
                            <MultiBinding>
                                <Binding Path="CurrentPage" />
                                <Binding Path="TotalPages" />
                                <MultiBinding.Converter>
                                    <conv:LessThanTotalPagesConverter/>
                                </MultiBinding.Converter>
                            </MultiBinding>
                        </Button.IsEnabled>
                    </Button>

                    <Button Text="Fim" Command="{Binding LastPageCommand}" CornerRadius="10" WidthRequest="80" />
                </StackLayout>

                <!-- Page Info -->
                <Label Text="{Binding PageInfo}"
               HorizontalOptions="Center"
               VerticalOptions="Center"
               FontSize="14"
               FontAttributes="Bold"
               Margin="0, 0, 0, 10"
               Grid.Row="6" />

            </VerticalStackLayout>
        </ScrollView>
        <ActivityIndicator x:Name="ai"
                    IsRunning="{Binding IsBusy}"
                    IsVisible="{Binding IsBusy}"
                    HorizontalOptions="Center"
                    VerticalOptions="Center"
                    BackgroundColor="LightBlue" 
                    HeightRequest="100"
                    WidthRequest="100" />

    </Grid>
</ContentPage>
