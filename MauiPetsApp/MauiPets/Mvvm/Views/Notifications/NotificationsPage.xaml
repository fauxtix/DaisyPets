<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="MauiPets.Mvvm.Views.Notifications.NotificationsPage"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:models="clr-namespace:MauiPets.Core.Domain.Notifications;assembly=MauiPets.Core"
             xmlns:enums="clr-namespace:MauiPets.Core.Application.Enums;assembly=MauiPets.Core"
             xmlns:local="clr-namespace:MauiPets.Mvvm.ViewModels.Notifications"
             xmlns:converters="clr-namespace:MauiPets.Converters"
             x:DataType="local:NotificationsViewModel"
             Title="Notificações"
             x:Name="NotificationsPageRoot">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
            <converters:StringNotNullOrEmptyConverter x:Key="StringNotNullOrEmptyConverter" />
            <converters:GreaterThanZeroConverter x:Key="GreaterThanZeroConverter" />
            <converters:NotificationTypeToPortugueseDescriptionConverter x:Key="NotificationTypeToPortugueseDescriptionConverter" />

            <!-- visibility converters -->
            <converters:IsNotDiscardedConverter x:Key="IsNotDiscardedConverter" />
            <converters:IsPendingAndNotDiscardedConverter x:Key="IsPendingAndNotDiscardedConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ContentPage.Content>
        <Grid Padding="8">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <CollectionView ItemsSource="{Binding Notifications}" Grid.Row="0">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Notification">
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItems SwipeBehaviorOnInvoked="Close">
                                    <!-- Mark as read: visible only when pending and not discarded -->
                                    <SwipeItem Text="Concluída"
                                               IconImageSource="check.png"
                                               BackgroundColor="LightGreen"
                                               Command="{Binding BindingContext.MarkAsReadCommand, Source={x:Reference NotificationsPageRoot}}"
                                               CommandParameter="{Binding .}"
                                               IsVisible="{Binding ., Converter={StaticResource IsPendingAndNotDiscardedConverter}}" />

                                    <!-- Discard (soft-delete): visible only when not discarded -->
                                    <SwipeItem Text="Descartar"
                                               IconImageSource="icon_delete2.svg"
                                               BackgroundColor="#FFCCCB"
                                               Command="{Binding BindingContext.DiscardNotificationCommand, Source={x:Reference NotificationsPageRoot}}"
                                               CommandParameter="{Binding .}"
                                               IsVisible="{Binding Status, Converter={StaticResource IsNotDiscardedConverter}}" />
                                </SwipeItems>
                            </SwipeView.RightItems>

                            <Frame Margin="2" Padding="10" BorderColor="Gray">
                                <!-- use enum static reference (enums prefix) -->
                                <Frame.Triggers>
                                    <DataTrigger TargetType="Frame"
                                                 Binding="{Binding Status}"
                                                 Value="{x:Static enums:NotificationStatus.Descartada}">
                                        <Setter Property="Opacity" Value="0.5" />
                                    </DataTrigger>
                                </Frame.Triggers>

                                <StackLayout>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>

                                        <Frame Padding="6,4"
                                               BorderColor="#FFD700"
                                               BackgroundColor="#FFFBE6"
                                               CornerRadius="8"
                                               HasShadow="False"
                                               HorizontalOptions="Start">
                                            <Label Text="{Binding Type.Description, Converter={StaticResource NotificationTypeToPortugueseDescriptionConverter}}"
                                                   FontSize="Medium"
                                                   FontFamily="PoppinsSemiBold"
                                                   TextColor="#8C7700"/>
                                        </Frame>

                                        <Frame Grid.Column="1"
                                               CornerRadius="12"
                                               Padding="8,2"
                                               HasShadow="False"
                                               HorizontalOptions="End"
                                               VerticalOptions="Start"
                                               BackgroundColor="#F0F0F0">
                                            <Grid>
                                                <!-- hide Lida/Pendente when discarded -->
                                                <Label Text="Lida"
                                                       TextColor="#228B22"
                                                       FontAttributes="Bold"
                                                       IsVisible="{Binding IsRead}"
                                                       VerticalOptions="Center"
                                                       HorizontalOptions="Center"
                                                       FontSize="Micro">
                                                    <Label.Triggers>
                                                        <DataTrigger TargetType="Label"
                                                                     Binding="{Binding Status}"
                                                                     Value="{x:Static enums:NotificationStatus.Descartada}">
                                                            <Setter Property="IsVisible" Value="False" />
                                                        </DataTrigger>
                                                    </Label.Triggers>
                                                </Label>

                                                <Label Text="Pendente"
                                                       TextColor="#B22222"
                                                       FontAttributes="Bold"
                                                       IsVisible="{Binding IsRead, Converter={StaticResource InverseBoolConverter}}"
                                                       VerticalOptions="Center"
                                                       HorizontalOptions="Center"
                                                       FontSize="Micro">
                                                    <Label.Triggers>
                                                        <DataTrigger TargetType="Label"
                                                                     Binding="{Binding Status}"
                                                                     Value="{x:Static enums:NotificationStatus.Descartada}">
                                                            <Setter Property="IsVisible" Value="False" />
                                                        </DataTrigger>
                                                    </Label.Triggers>
                                                </Label>
                                            </Grid>
                                        </Frame>
                                    </Grid>

                                    <!-- Discarded badge (visible only when Status == Descartada) -->
                                    <Label Text="Descartada"
                                           FontSize="Micro"
                                           FontAttributes="Bold"
                                           TextColor="#777"
                                           HorizontalOptions="End"
                                           IsVisible="False"
                                           Margin="0,4,4,0">
                                        <Label.Triggers>
                                            <DataTrigger TargetType="Label"
                                                         Binding="{Binding Status}"
                                                         Value="{x:Static enums:NotificationStatus.Descartada}">
                                                <Setter Property="IsVisible" Value="True" />
                                            </DataTrigger>
                                        </Label.Triggers>
                                    </Label>

                                    <Label Text="Lida"
                                           TextColor="#228B22"
                                           FontAttributes="Bold"
                                           IsVisible="{Binding IsRead}">
                                        <Label.Triggers>
                                            <DataTrigger TargetType="Label"
                                                         Binding="{Binding Status}"
                                                         Value="{x:Static enums:NotificationStatus.Descartada}">
                                                <Setter Property="IsVisible" Value="False" />
                                            </DataTrigger>
                                        </Label.Triggers>
                                    </Label>

                                    <Grid RowDefinitions="Auto, Auto" ColumnDefinitions="220, 120" Margin="0, 10, 0, 0">
                                        <Label Grid.Row="0"
                                               Grid.ColumnSpan="2"
                                               Text="{Binding Title}"
                                               FontAttributes="Bold"
                                               FontFamily="Poppins"
                                               IsVisible="{Binding Title, Converter={StaticResource StringNotNullOrEmptyConverter}}" />

                                        <Label Grid.Row="1" Grid.Column="0" Text="{Binding Description}" FontAttributes="Bold" FontFamily="Poppins" />
                                        <Label Grid.Row="1" Grid.Column="1" Text="{Binding ScheduledFor, StringFormat=' {0:dd/MM/yyyy}'}"
                                               FontFamily="PoppinsSemiBold"
                                               HorizontalTextAlignment="End"
                                               TextColor="Green" />
                                    </Grid>
                                </StackLayout>
                            </Frame>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <CollectionView.EmptyView>
                    <StackLayout Margin="0, 10, 0, 0" HorizontalOptions="Center">
                        <Image HorizontalOptions="Center"
                               HeightRequest="160"
                               WidthRequest="160"
                               Source="tasks.png"
                               VerticalOptions="Center" />
                        <Label HorizontalOptions="Center"
                               Margin="10,10,10,0"
                               FontSize="Body"
                               FontFamily="NotoSerifBold"
                               Text="Nenhuma notificação pendente"
                               VerticalOptions="Center" />
                        <Button Text="Mostrar todas as notificações"
                                Command="{Binding ShowAllNotificationsCommand}"
                                Margin="10,20,10,0"
                                HorizontalOptions="Center" />
                    </StackLayout>
                </CollectionView.EmptyView>
            </CollectionView>

            <Grid IsVisible="{Binding IsBusy}" BackgroundColor="#80000000"
                  VerticalOptions="Fill" HorizontalOptions="Fill"
                  ZIndex="10">
                <ActivityIndicator IsRunning="{Binding IsBusy}"
                                   IsVisible="{Binding IsBusy}"
                                   VerticalOptions="Center"
                                   HorizontalOptions="Center"
                                   Color="White"
                                   WidthRequest="64"
                                   HeightRequest="64" />
            </Grid>
        </Grid>
    </ContentPage.Content>
</ContentPage>