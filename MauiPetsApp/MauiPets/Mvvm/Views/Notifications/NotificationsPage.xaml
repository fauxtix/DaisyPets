<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="MauiPets.Mvvm.Views.Notifications.NotificationsPage"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:models="clr-namespace:MauiPets.Core.Domain.Notifications;assembly=MauiPets.Core"
             xmlns:local="clr-namespace:MauiPets.Mvvm.ViewModels.Notifications"
             xmlns:converters="clr-namespace:MauiPets.Converters"
             x:DataType="local:NotificationsViewModel"
             Title="Notificações"
             x:Name="NotificationsPageRoot">

    <Shell.BackButtonBehavior>
        <BackButtonBehavior IsVisible="False" IsEnabled="False" />
    </Shell.BackButtonBehavior>
    <ContentPage.ToolbarItems>
        <ToolbarItem Command="{Binding GoBackCommand  }"
                 IconImageSource="icon_close.svg" />
    </ContentPage.ToolbarItems>


    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
            <converters:StringNotNullOrEmptyConverter x:Key="StringNotNullOrEmptyConverter" />
            <converters:GreaterThanZeroConverter x:Key="GreaterThanZeroConverter" />
            <converters:NotificationTypeToPortugueseDescriptionConverter x:Key="NotificationTypeToPortugueseDescriptionConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>
    <ContentPage.Content>
        <Grid>
            <CollectionView ItemsSource="{Binding Notifications}">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Notification">
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItems SwipeBehaviorOnInvoked="Close">
                                    <SwipeItem Text="Concluída" 
                                                   IconImageSource="check.png"
                                                   BackgroundColor="LightGreen"
                                                   Command="{Binding BindingContext.MarkAsReadCommand, Source={x:Reference NotificationsPageRoot}}"
                                                   CommandParameter="{Binding .}"
                                                   IsVisible="{Binding IsRead, Converter={StaticResource InverseBoolConverter}}" />
                                    <SwipeItem 
                                                   IconImageSource="icon_delete2.svg"
                                                   Command="{Binding BindingContext.DiscardNotificationCommand, Source={x:Reference NotificationsPageRoot}}"
                                                   CommandParameter="{Binding .}"
                                                   IsVisible="{Binding IsRead}" />
                                </SwipeItems>
                            </SwipeView.RightItems>
                            <Frame Margin="2" Padding="10" BorderColor="Gray">
                                <StackLayout>
                                    <Frame
                                            Padding="6,4"
                                            BorderColor="#FFD700"
                                            BackgroundColor="#FFFBE6"
                                            CornerRadius="8"
                                            HasShadow="False"
                                            HorizontalOptions="Start">
                                        <Label
                                                Text="{Binding Type.Description, Converter={StaticResource NotificationTypeToPortugueseDescriptionConverter}}"
                                                FontSize="Medium"                                               
                                                FontFamily="PoppinsSemiBold"
                                                TextColor="#8C7700"/>
                                    </Frame>
                                    <Grid RowDefinitions="Auto, Auto"  ColumnDefinitions="220, 120" Margin="0, 10, 0, 0">
                                        <Label Grid.Row="0"
                                               Grid.ColumnSpan="2"
                                               Text="{Binding Title}"
                                               FontAttributes="Bold"
                                               FontFamily="Poppins"
                                               IsVisible="{Binding Title, Converter={StaticResource StringNotNullOrEmptyConverter}}" />

                                        <Label Grid.Row="1" Grid.Column="0" Text="{Binding Description}" FontAttributes="Bold" FontFamily="Poppins" />
                                        <Label Grid.Row="1" Grid.Column="1" Text="{Binding ScheduledFor, StringFormat=' {0:dd/MM/yyyy}'}" 
                                               FontFamily="PoppinsSemiBold"
                                               HorizontalTextAlignment="End"
                                               TextColor="Green" />
                                    </Grid>
                                </StackLayout>
                            </Frame>
                        </SwipeView>

                    </DataTemplate>
                    

                </CollectionView.ItemTemplate>
                <!--<CollectionView.Footer>
                        <Button Text="Apagar todas as notificações"
                                Command="{Binding DeleteAllNotificationsCommand}"
                                IsVisible="{Binding Notifications.Count, Converter={StaticResource GreaterThanZeroConverter}}"
                                Margin="10"/>
                    </CollectionView.Footer>-->
                <CollectionView.EmptyView>
                    <StackLayout Margin="0, 10, 0, 0">
                        <Image HorizontalOptions="Center"
                                   HeightRequest="160"
                                   WidthRequest="160"
                                   Source="tasks.png"
                                   VerticalOptions="Center" />
                        <Label HorizontalOptions="Center"
                                   Margin="10,10,10,0"
                                   FontSize="Body"
                                   FontFamily="NotoSerifBold"
                                   Text="Nenhuma notificação encontrada"
                                   VerticalOptions="Center" />
                        <Button Text="Mostrar todas as notificações"
                                    Command="{Binding ShowAllNotificationsCommand}"
                                    Margin="10,20,10,0"
                                    HorizontalOptions="Center" />
                    </StackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
            <Grid IsVisible="{Binding IsBusy}" BackgroundColor="#80000000"  
                  VerticalOptions="Fill" HorizontalOptions="Fill"
                  ZIndex="10">
                <ActivityIndicator IsRunning="{Binding IsBusy}" 
                                   IsVisible="{Binding IsBusy}" 
                                   VerticalOptions="Center"
                                   HorizontalOptions="Center"
                                   Color="White"
                                   WidthRequest="64"
                                   HeightRequest="64" />
            </Grid>
        </Grid>
    </ContentPage.Content>
</ContentPage>